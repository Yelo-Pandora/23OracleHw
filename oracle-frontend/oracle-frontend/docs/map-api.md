## 地图接口说明（前端预留，后端对接指南）

基础约定
- 基础路径：`/api/map`（由前端 Vite 代理转发到后端主机）
- 数据格式：JSON；时间 `ISO8601`；坐标为平面像素（CRS.Simple）。
- 认证：使用后端颁发的 Token（如 Bearer）。

术语模型
- Area: `{ id, name, floor, type: 'shop'|'event'|'other', status, points?: number[][], x?, y?, w?, h?, areaSize?, rent?, remark? }`
- Device: `{ id, floor, type:'elevator'|'camera'|'light'|'ac', x, y }`
- Parking: `{ id, no, floor:-1, x, y, w, h, occupied, skew }`

权限矩阵
- visitor/employee: 只读（GET）。
- admin/region_admin: 读写（GET/POST/PUT/DELETE/IMPORT/EXPORT）。

接口列表（含参数/返回）
1) GET `/api/map/floors`
   - 描述：返回可用楼层列表
   - 响应：`number[]`，示例：`[-1,1,2,3]`

2) GET `/api/map/floors/{floor}`
   - 路径参数：`floor`(-1|1|2|3)
   - 查询参数（可选）：`type`(shop|event|other|parking)，`keyword`(模糊匹配 id/name)
   - 响应：
   ```json
   {
     "areas": [Area],
     "devices": [Device],
     "parking": [Parking]
   }
   ```

3) PUT `/api/map/floors/{floor}/areas`
   - 路径参数：`floor`
   - 请求体：`Area[]`（全量覆盖该楼层区域）
   - 响应：`{ "success": true, "count": number }`

4) POST `/api/map/floors/{floor}/areas`
   - 路径参数：`floor`
   - 请求体：`Area`（新增或覆盖同 ID）
   - 响应：`Area`

5) DELETE `/api/map/floors/{floor}/areas/{id}`
   - 路径参数：`floor`, `id`
   - 响应：`{ "success": true }`

6) GET `/api/map/floors/{floor}/devices`
   - 路径参数：`floor`
   - 响应：`Device[]`

7) PUT `/api/map/floors/{floor}/devices`
   - 路径参数：`floor`
   - 请求体：`Device[]`（全量覆盖）
   - 响应：`{ "success": true, "count": number }`

8) GET `/api/map/floors/{floor}/parking`
   - 路径参数：`floor`（目前仅 `-1`）
   - 响应：`Parking[]`

9) PUT `/api/map/floors/{floor}/parking`
   - 路径参数：`floor`
   - 请求体：`Parking[]`（全量覆盖）
   - 响应：`{ "success": true, "count": number }`

10) GET `/api/map/floors/{floor}/export`
   - 响应：`application/geo+json` 文件（含 areas/parking/devices 三类要素）

11) POST `/api/map/floors/{floor}/import`
   - 表单：`file`(GeoJSON)
   - 响应：`{ "success": true, "areas": number, "parking": number, "devices": number }`

错误码
- 400: 参数错误/无效坐标
- 401: 未认证
- 403: 无权限（游客/员工尝试写）
- 404: 楼层不存在
- 409: ID 冲突
- 500: 服务器异常

示例（精简）
```json
GET /api/map/floors/1
{"areas":[{"id":"12","name":"","floor":1,"type":"shop","status":"空闲","points":[[260,460],[300,460],[300,500],[260,500]]}],"devices":[{"id":"D1","floor":1,"type":"elevator","x":360,"y":160}],"parking":[]}
```

对接说明
- 前端目前开启 `USE_MOCK`，后端接入后将其关闭并由 Vite 代理 `/api/*` 到后端。
- `points` 须按 `[x,y]` 序，矩形可用 `x,y,w,h` 简写。

---

## 数据库设计（Oracle 推荐）

命名空间：`MAP_` 前缀

1) 楼层表 `MAP_FLOOR`
```sql
CREATE TABLE MAP_FLOOR (
  FLOOR_NO NUMBER(4) PRIMARY KEY, -- -1,1,2,3
  TITLE    VARCHAR2(64)
);
```

2) 区域表 `MAP_AREA`
```sql
CREATE TABLE MAP_AREA (
  ID         VARCHAR2(64) PRIMARY KEY,
  FLOOR_NO   NUMBER(4)     NOT NULL,
  NAME       VARCHAR2(128),
  TYPE       VARCHAR2(16)  CHECK (TYPE IN ('shop','event','other')),
  STATUS     VARCHAR2(32),
  -- 几何，两种其一：优先 points_json，为多边形；否则使用 x/y/w/h
  POINTS_JSON CLOB, -- [[x,y],[x,y],...]
  X          NUMBER(10,2),
  Y          NUMBER(10,2),
  W          NUMBER(10,2),
  H          NUMBER(10,2),
  AREA_SIZE  NUMBER(14,2),
  RENT       NUMBER(14,2),
  REMARK     VARCHAR2(400),
  CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
  UPDATED_AT TIMESTAMP
);
CREATE INDEX IX_AREA_FLOOR ON MAP_AREA(FLOOR_NO);
CREATE INDEX IX_AREA_TYPE  ON MAP_AREA(TYPE);
```

3) 设备表 `MAP_DEVICE`
```sql
CREATE TABLE MAP_DEVICE (
  ID        VARCHAR2(64) PRIMARY KEY,
  FLOOR_NO  NUMBER(4)    NOT NULL,
  TYPE      VARCHAR2(16) CHECK (TYPE IN ('elevator','camera','light','ac')),
  X         NUMBER(10,2) NOT NULL,
  Y         NUMBER(10,2) NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP
);
CREATE INDEX IX_DEVICE_FLOOR ON MAP_DEVICE(FLOOR_NO);
CREATE INDEX IX_DEVICE_TYPE  ON MAP_DEVICE(TYPE);
```

4) 停车位表 `MAP_PARKING`
```sql
CREATE TABLE MAP_PARKING (
  ID        VARCHAR2(64) PRIMARY KEY,
  NO        NUMBER(8)    NOT NULL,
  FLOOR_NO  NUMBER(4)    DEFAULT -1,
  X         NUMBER(10,2),
  Y         NUMBER(10,2),
  W         NUMBER(10,2),
  H         NUMBER(10,2),
  SKEW      NUMBER(10,2),
  OCCUPIED  NUMBER(1) DEFAULT 0 CHECK (OCCUPIED IN (0,1)),
  UPDATED_AT TIMESTAMP
);
CREATE UNIQUE INDEX UX_PARKING_NO ON MAP_PARKING(FLOOR_NO, NO);
CREATE INDEX IX_PARKING_OCCUPIED ON MAP_PARKING(OCCUPIED);
```

5) 操作日志（可选） `MAP_AUDIT`
```sql
CREATE TABLE MAP_AUDIT (
  ID        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ACTOR     VARCHAR2(64),
  ACTION    VARCHAR2(32),   -- CREATE/UPDATE/DELETE/IMPORT/EXPORT
  TARGET    VARCHAR2(64),    -- areaId/deviceId/parkingId/floor
  DETAILS   CLOB,
  TS        TIMESTAMP DEFAULT SYSTIMESTAMP
);
```

### 数据映射建议
- Area.points ↔ MAP_AREA.POINTS_JSON（JSON CLOB）
- 矩形 Area ↔ X/Y/W/H 四列
- Parking 占用状态 ↔ `OCCUPIED`（0/1）
- 读写时按 `FLOOR_NO` 过滤；ID 冲突返回 409

---




