<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>停车场2.8.2功能测试页面</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.2em;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-test {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-test:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .result-section {
            margin-top: 25px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .overview-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .overview-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .overview-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-normal { background: #d4edda; color: #155724; }
        .status-maintenance { background: #fff3cd; color: #856404; }
        .status-suspended { background: #f8d7da; color: #721c24; }
        .status-full { background: #d1ecf1; color: #0c5460; }
        
        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
        }
        
        .stat-value.available { color: #28a745; }
        .stat-value.occupied { color: #dc3545; }
        
        .card-footer {
            text-align: center;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            font-weight: 600;
        }
        
        .can-park { color: #28a745; }
        .cannot-park { color: #dc3545; }
        
        .statistics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-card.available {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .stat-card.occupied {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-card.available .stat-number { color: #28a745; }
        .stat-card.occupied .stat-number { color: #dc3545; }
        
        .stat-card-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }
        
        .parking-status-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-label {
            font-weight: 600;
            color: #333;
        }
        
        .can-park-indicator {
            margin-left: auto;
            font-weight: 600;
        }
        
        .parking-spaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .parking-space {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid;
            position: relative;
        }
        
        .parking-space.available {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .parking-space.occupied {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .parking-space:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .space-id {
            font-size: 1em;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .space-status {
            font-size: 0.75em;
            margin-bottom: 3px;
        }
        
        .license-plate {
            font-size: 0.65em;
            background: rgba(0,0,0,0.1);
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 3px;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .park-duration {
            font-size: 0.65em;
            opacity: 0.8;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-space {
            width: 25px;
            height: 25px;
            border-radius: 4px;
            border: 2px solid;
        }
        
        .legend-space.available {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .legend-space.occupied {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .update-time {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            font-style: italic;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .parking-spaces-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
            }
            
            .statistics-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 停车场2.8.2功能测试</h1>
            <p>用例2.8.2 - 停车场车位状态查询功能测试页面</p>
        </div>
        
        <div class="content">
            <!-- 功能说明 -->
                    <div class="form-section" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
            <h3>🎯 功能2.8.2说明</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <div>
                    <strong>主要功能:</strong><br>
                    • 车位状态查询 (GET /spaces)<br>
                    • 支持按停车场区域查询<br>
                    • 实时车位占用状态显示<br>
                    • 车位统计信息展示
                </div>
                <div>
                    <strong>权限要求:</strong><br>
                    • 匿名访问: 可查询<br>
                    • 员工权限: 可查询<br>
                    • 管理员权限: 可查询<br>
                    • 需要权限级别 ≤ 3
                </div>
            </div>
        </div>
            

            
            <!-- 控制面板 -->
            <div class="form-section">
                <h3>🎛️ 控制面板</h3>
                
                <div class="form-group">
                    <label for="operatorAccount">操作员账号:</label>
                    <select id="operatorAccount">
                        <option value="">-- 请选择操作员账号 --</option>
                        <option value="admin_test">admin_test (管理员测试)</option>
                        <option value="manager_test">manager_test (经理测试)</option>
                        <option value="staff_test">staff_test (员工测试)</option>
                        <option value="invalid_user">invalid_user (无效用户)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="apiBaseUrl">API服务地址:</label>
                    <input type="text" id="apiBaseUrl" value="http://localhost:5263/api/Parking" placeholder="请输入API服务地址">
                    <button onclick="testApiConnection()" class="btn btn-test" style="margin-left: 10px;">测试连接</button>
                </div>
                
                <div class="form-group">
                    <label for="areaSelect">选择停车场区域:</label>
                    <select id="areaSelect">
                        <option value="1001">1001 (测试停车场A)</option>
                        <option value="1002">1002 (测试停车场B)</option>
                        <option value="1003">1003 (测试停车场C)</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="fetchParkingSpaceStatus()">
                        🔍 查询车位状态
                    </button>
                    <button class="btn btn-primary" onclick="manualRefresh()">
                        🔄 立即刷新数据
                    </button>
                    <label class="auto-refresh">
                        <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                        🔄 自动刷新 (5秒)
                    </label>
                </div>
            </div>
            
            <!-- 结果显示区域 -->
            <div class="result-section">
                <div id="alertContainer"></div>
                <div id="overviewContainer"></div>
                <div id="detailContainer"></div>
                <div id="jsonContainer"></div>
            </div>
            

        </div>
    </div>

    <script>
        // 获取API基础URL
        function getApiBaseUrl() {
            return document.getElementById('apiBaseUrl').value.trim() || 'http://localhost:5263/api/Parking';
        }
        let autoRefreshInterval = null;
        let currentOverviewData = null;
        
        // 显示提示信息
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'error' ? 'alert-error' : 
                              type === 'warning' ? 'alert-warning' : 'alert-success';
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            // 3秒后自动隐藏
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 3000);
        }
        
        // 显示加载状态
        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在加载数据...</p>
                </div>
            `;
        }
        
        // 获取操作员账号
        function getOperatorAccount() {
            return document.getElementById('operatorAccount').value;
        }
        
        // 获取选中的区域ID
        function getSelectedAreaId() {
            return document.getElementById('areaSelect').value;
        }
        
        // 测试API连接
        async function testApiConnection() {
            const testButton = event.target;
            const originalText = testButton.textContent;
            
            testButton.textContent = '测试中...';
            testButton.disabled = true;
            
            try {
                const apiUrl = getApiBaseUrl();
                // 使用2.8.2自己的API端点来检查状态
                const testUrl = `${apiUrl}/summary`;
                
                console.log('测试API连接:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showAlert('✅ API连接测试成功！停车场概览统计服务可用', 'success');
                    console.log('API连接测试成功，状态码:', response.status);
                } else {
                    showAlert(`❌ API连接失败！状态码: ${response.status}`, 'error');
                    console.error('API连接失败，状态码:', response.status);
                }
            } catch (error) {
                showAlert(`❌ API连接异常！${error.message}`, 'error');
                console.error('API连接异常:', error);
            } finally {
                testButton.textContent = originalText;
                testButton.disabled = false;
            }
        }
        
        // 测试权限级别
        async function testPermissionLevels() {
            const operatorAccount = getOperatorAccount();
            const areaId = getSelectedAreaId();
            const apiUrl = getApiBaseUrl();

            if (!operatorAccount) {
                showAlert('请先选择一个操作员账号！', 'warning');
                return;
            }

            showLoading('overviewContainer');
            try {
                // 使用正确的API端点测试权限：GetParkingLotInfo/{areaId}
                const url = `${apiUrl}/GetParkingLotInfo/${areaId || 1001}`;
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert(`✅ 权限级别测试成功！账号 "${operatorAccount}" 具有访问权限。`, 'success');
                    
                    // 获取所有停车场信息
                    await fetchAllParkingLots();
                } else {
                    const errorMsg = data.error || data.Error || '未知错误';
                    showAlert(`❌ 权限级别测试失败: ${errorMsg}`, 'error');
                    document.getElementById('overviewContainer').innerHTML = '';
                    document.getElementById('jsonContainer').innerHTML = `
                        <h4>📄 错误响应:</h4>
                        <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                    `;
                }
            } catch (error) {
                showAlert(`❌ 网络错误: ${error.message}`, 'error');
                document.getElementById('overviewContainer').innerHTML = '';
                console.error('权限级别测试失败:', error);
                
                // 显示详细错误信息
                document.getElementById('jsonContainer').innerHTML = `
                    <h4>📄 网络错误详情:</h4>
                    <div class="json-display">错误类型: ${error.name}
错误消息: ${error.message}
                    请求URL: ${apiUrl}/GetParkingLotInfo/${areaId || 1001}
时间: ${new Date().toLocaleString()}</div>
                `;
            }
        }
        
        // 获取所有停车场概览
        async function fetchAllParkingLots() {
            showLoading('overviewContainer');
            
            try {
                const operatorAccount = getOperatorAccount();
                
                // 使用正确的API端点：GetParkingLotInfo/{areaId} 来获取每个停车场的详细信息
                const parkingLots = [1001, 1002, 1003];
                const overviewData = [];
                
                for (const areaId of parkingLots) {
                    try {
                        const url = `${getApiBaseUrl()}/GetParkingLotInfo/${areaId}`;
                        console.log(`获取停车场 ${areaId} 信息:`, url);
                        
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            // 转换数据格式以匹配displayOverview函数的期望
                            const lotInfo = {
                                AreaId: data.data.AreaId,
                                ParkingFee: data.data.ParkingFee,
                                TotalSpaces: data.data.TotalSpaces,
                                OccupiedSpaces: data.data.OccupiedSpaces,
                                AvailableSpaces: data.data.AvailableSpaces,
                                OccupancyRate: data.data.OccupancyRate,
                                Status: data.data.Status,
                                LastUpdateTime: data.data.LastUpdateTime,
                                CanPark: data.data.CanPark
                            };
                            overviewData.push(lotInfo);
                        } else {
                            console.warn(`获取停车场 ${areaId} 信息失败:`, data);
                        }
                    } catch (error) {
                        console.error(`获取停车场 ${areaId} 信息时发生错误:`, error);
                    }
                }
                
                if (overviewData.length > 0) {
                    currentOverviewData = overviewData;
                    displayOverview(overviewData);
                    showAlert(`✅ 成功获取 ${overviewData.length} 个停车场信息`);
                    
                    // 显示JSON数据
                    document.getElementById('jsonContainer').innerHTML = `
                        <h4>📄 API响应数据 (GetParkingLotInfo):</h4>
                        <div class="json-display">${JSON.stringify(overviewData, null, 2)}</div>
                    `;
                } else {
                    showAlert('❌ 未能获取任何停车场信息', 'error');
                    document.getElementById('overviewContainer').innerHTML = '';
                }
            } catch (error) {
                showAlert(`❌ 网络错误: ${error.message}`, 'error');
                document.getElementById('overviewContainer').innerHTML = '';
                console.error('获取停车场概览失败:', error);
                
                // 显示详细错误信息
                document.getElementById('jsonContainer').innerHTML = `
                    <h4>📄 网络错误详情:</h4>
                    <div class="json-display">错误类型: ${error.name}
错误消息: ${error.message}
时间: ${new Date().toLocaleString()}</div>
                `;
            }
        }
        
        // 显示停车场概览
        function displayOverview(data) {
            const container = document.getElementById('overviewContainer');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p>暂无停车场数据</p>';
                return;
            }
            
            const overviewHtml = `
                <h3>📋 停车场概览 (共${data.length}个停车场)</h3>
                <div class="overview-grid">
                    ${data.map(lot => `
                        <div class="overview-card ${lot.AreaId == getSelectedAreaId() ? 'selected' : ''}" 
                             onclick="selectParkingLot(${lot.AreaId})">
                            <div class="card-header">
                                <h4 class="card-title">停车场 ${lot.AreaId}</h4>
                                <span class="status-badge status-${getStatusClass(lot.Status)}">
                                    ${lot.Status}
                                </span>
                            </div>
                            <div class="card-stats">
                                <div class="stat-item">
                                    <span class="stat-label">总车位:</span>
                                    <span class="stat-value">${lot.TotalSpaces}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">可用:</span>
                                    <span class="stat-value available">${lot.AvailableSpaces}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">占用:</span>
                                    <span class="stat-value occupied">${lot.OccupiedSpaces}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">占用率:</span>
                                    <span class="stat-value">${lot.OccupancyRate}%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">停车费:</span>
                                    <span class="stat-value">¥${lot.ParkingFee}/小时</span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <span class="${lot.CanPark ? 'can-park' : 'cannot-park'}">
                                    ${lot.CanPark ? '✅ 可停车' : '❌ 不可停车'}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="update-time">
                    数据更新时间: ${new Date().toLocaleString()}
                </div>
            `;
            
            container.innerHTML = overviewHtml;
        }
        
        // 选择停车场
        function selectParkingLot(areaId) {
            document.getElementById('areaSelect').value = areaId;
            fetchParkingSpaceStatus();
            
            // 更新选中状态
            if (currentOverviewData) {
                displayOverview(currentOverviewData);
            }
        }
        
        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case '正常运营': return 'normal';
                case '维护中': return 'maintenance';
                case '暂停服务': return 'suspended';
                case '已满': return 'full';
                default: return 'normal';
            }
        }
        
        // 获取车位状态详情
        async function fetchParkingSpaceStatus() {
            const areaId = getSelectedAreaId();
            showLoading('detailContainer');
            
            try {
                const operatorAccount = getOperatorAccount();
                
                // 如果没有概览数据，先获取停车场概览
                if (!currentOverviewData) {
                    console.log('没有概览数据，先获取停车场概览...');
                    try {
                        // 使用正确的API端点获取概览数据
                        await fetchAllParkingLots();
                    } catch (overviewError) {
                        console.warn('获取概览数据失败，将使用默认状态:', overviewError);
                    }
                }
                
                // 使用2.8.2的API端点获取车位状态
                const url = `${getApiBaseUrl()}/spaces${operatorAccount ? '?operatorAccount=' + encodeURIComponent(operatorAccount) : ''}${areaId ? '&areaId=' + areaId : ''}`;
                
                console.log('请求URL:', url);
                console.log('操作员账号:', operatorAccount);
                console.log('区域ID:', areaId);
                
                const response = await fetch(url);
                console.log('响应状态:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('响应数据:', data);
                
                if (response.ok && data.success) {
                    if (data.data && data.data.length > 0) {
                        displayParkingSpaceDetails(data.data, areaId);
                        showAlert(`✅ 成功获取停车场 ${areaId} 的车位状态`);
                    } else {
                        // 没有车位数据时显示空状态
                        document.getElementById('detailContainer').innerHTML = `
                            <div class="alert alert-info">
                                <h4>停车场 ${areaId} 状态</h4>
                                <p>该停车场暂无车位数据</p>
                                <p>查询时间: ${new Date(data.timestamp).toLocaleString()}</p>
                            </div>
                        `;
                        showAlert(`ℹ️ 停车场 ${areaId} 暂无车位数据`, 'info');
                    }
                    
                    // 显示JSON数据
                    document.getElementById('jsonContainer').innerHTML = `
                        <h4>📄 API响应数据 (GetParkingSpaceStatus/${areaId}):</h4>
                        <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                    `;
                } else {
                    const errorMsg = data.error || data.Error || '未知错误';
                    showAlert(`❌ 获取车位状态失败: ${errorMsg}`, 'error');
                    document.getElementById('detailContainer').innerHTML = '';
                    document.getElementById('jsonContainer').innerHTML = `
                        <h4>📄 错误响应:</h4>
                        <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                    `;
                }
            } catch (error) {
                let errorMessage = '网络连接错误';
                if (error.name === 'SyntaxError' && error.message.includes('Unexpected end of JSON input')) {
                    errorMessage = '服务器返回了空响应，请检查API地址是否正确或服务器是否正常运行';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showAlert(`❌ ${errorMessage}`, 'error');
                document.getElementById('detailContainer').innerHTML = '';
                console.error('获取停车场信息失败:', error);
                
                // 显示详细错误信息
                document.getElementById('jsonContainer').innerHTML = `
                    <h4>📄 错误详情:</h4>
                    <div class="json-display">错误类型: ${error.name}
错误消息: ${error.message}
请求URL: ${getApiBaseUrl()}/spaces?areaId=${areaId}
时间: ${new Date().toLocaleString()}</div>
                `;
            }
        }
        
        // 显示车位状态详情
        function displayParkingSpaceDetails(spaces, areaId) {
            const container = document.getElementById('detailContainer');
            
            // 计算统计信息
            const totalSpaces = spaces.length;
            const occupiedSpaces = spaces.filter(s => s.occupied === 1).length;
            const availableSpaces = totalSpaces - occupiedSpaces;
            const occupancyRate = totalSpaces > 0 ? (occupiedSpaces / totalSpaces * 100).toFixed(2) : 0;
            
            // 从概览数据中获取停车场状态，如果没有则默认为正常运营
            let parkingLotStatus = "正常运营";
            let canPark = availableSpaces > 0;
            
            // 如果有概览数据，使用真实的停车场状态
            if (currentOverviewData) {
                const parkingLot = currentOverviewData.find(lot => lot.AreaId == areaId);
                if (parkingLot) {
                    parkingLotStatus = parkingLot.Status;
                    // 可停车需要同时满足：有可用车位 且 状态为正常运营
                    canPark = availableSpaces > 0 && parkingLotStatus === "正常运营";
                }
            }
            
            const detailHtml = `
                <h3>🚙 停车场 ${areaId} 详细车位状态</h3>
                
                <!-- 统计面板 -->
                <div class="statistics-panel">
                    <div class="stat-card">
                        <div class="stat-number">${totalSpaces}</div>
                        <div class="stat-card-label">总车位数</div>
                    </div>
                    <div class="stat-card available">
                        <div class="stat-number">${availableSpaces}</div>
                        <div class="stat-card-label">空闲车位</div>
                    </div>
                    <div class="stat-card occupied">
                        <div class="stat-number">${occupiedSpaces}</div>
                        <div class="stat-card-label">占用车位</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${occupancyRate}%</div>
                        <div class="stat-card-label">占用率</div>
                    </div>
                </div>
                
                <!-- 停车场状态信息 -->
                <div class="parking-status-info">
                    <span class="status-label">停车场状态:</span>
                    <span class="status-badge status-${getStatusClass(parkingLotStatus)}">
                        ${parkingLotStatus}
                    </span>
                    <span class="can-park-indicator ${canPark ? 'can-park' : 'cannot-park'}">
                        ${canPark ? '✅ 可停车' : '❌ 不可停车'}
                    </span>
                </div>
                
                <!-- 车位网格 -->
                <div class="parking-spaces-grid">
                    ${spaces.map(space => `
                        <div class="parking-space ${space.occupied === 1 ? 'occupied' : 'available'}"
                             title="车位 ${space.parkingSpaceId} - ${space.status}${space.licensePlateNumber ? ' - ' + space.licensePlateNumber : ''}"
                             onclick="fetchSingleSpaceById(${space.parkingSpaceId})">
                            <div class="space-id">${space.parkingSpaceId}</div>
                            <div class="space-status">${space.status}</div>
                            ${space.licensePlateNumber ? `<div class="license-plate">${space.licensePlateNumber}</div>` : ''}
                            ${space.parkStart ? `<div class="park-duration">已停车</div>` : ''}
                        </div>
                    `).join('')}
                </div>
                
                <!-- 图例 -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-space available"></div>
                        <span>空闲车位</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-space occupied"></div>
                        <span>占用车位</span>
                    </div>
                </div>
                
                <div class="update-time">
                    最后更新: ${new Date().toLocaleString()}
                </div>
            `;
            
            container.innerHTML = detailHtml;
        }
        
        // 查询单个车位状态
        async function fetchSingleSpace() {
            const parkingSpaceId = prompt('请输入要查询的车位ID:');
            if (!parkingSpaceId) return;
            
            await fetchSingleSpaceById(parkingSpaceId);
        }
        
        // 根据ID查询单个车位状态
        async function fetchSingleSpaceById(parkingSpaceId) {
            try {
                const operatorAccount = getOperatorAccount();
                // 使用2.8.2的API端点查询单个车位状态
                const url = `${getApiBaseUrl()}/GetSingleParkingSpaceStatus/${parkingSpaceId}${operatorAccount ? '?operatorAccount=' + encodeURIComponent(operatorAccount) : ''}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert(`✅ 车位 ${parkingSpaceId} 状态: ${data.status}`);
                    
                    // 显示单个车位详情
                    const detailInfo = `
                        车位ID: ${data.parkingSpaceId}
                        所属区域: ${data.areaId}
                        状态: ${data.status}
                        ${data.licensePlateNumber ? `车牌号: ${data.licensePlateNumber}` : ''}
                        ${data.parkDuration ? `停车时长: ${data.parkDuration}` : ''}
                        更新时间: ${new Date(data.updateTime).toLocaleString()}
                    `;
                    
                    alert(`🚙 车位详情\n\n${detailInfo}`);
                    
                    // 显示JSON数据
                    document.getElementById('jsonContainer').innerHTML = `
                        <h4>📄 API响应数据 (GetSingleParkingSpaceStatus/${parkingSpaceId}):</h4>
                        <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                    `;
                } else {
                    showAlert(`❌ ${data.error || '未知错误'}`, 'error');
                    document.getElementById('jsonContainer').innerHTML = `
                        <h4>📄 错误响应:</h4>
                        <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                    `;
                }
                
            } catch (error) {
                showAlert(`❌ 网络错误: ${error.message}`, 'error');
                console.error('查询单个车位失败:', error);
            }
        }
        
        // 手动刷新数据
        function manualRefresh() {
            showAlert('🔄 正在手动刷新数据...', 'info');
            
            // 清除当前概览数据，强制重新获取
            currentOverviewData = null;
            
            // 重新获取停车场概览数据
            fetchAllParkingLots();
            
            // 如果有选中的停车场，也重新获取车位状态
            const selectedAreaId = getSelectedAreaId();
            if (selectedAreaId) {
                setTimeout(() => {
                    fetchParkingSpaceStatus();
                }, 500);
            }
        }
        
        // 切换自动刷新
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(() => {
                    fetchParkingSpaceStatus();
                    if (currentOverviewData) {
                        fetchAllParkingLots();
                    }
                }, 5000);
                showAlert('🔄 已开启自动刷新 (每5秒)', 'success');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                showAlert('⏹️ 已关闭自动刷新', 'warning');
            }
        }
        
        // 页面加载完成后自动获取数据
        window.onload = function() {
            showAlert('🚀 页面加载完成，开始获取停车场数据...');
            fetchAllParkingLots();
            setTimeout(() => {
                fetchParkingSpaceStatus();
            }, 1000);
        };
        
        // 页面卸载时清理定时器
        window.onbeforeunload = function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        };
    </script>
</body>
</html>

