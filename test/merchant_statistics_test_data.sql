-- 商户信息统计报表功能测试数据 (用例2.7.5)
-- 创建丰富的测试数据以支持统计报表功能

-- 0. 确保管理员账号存在（用于权限验证）
BEGIN
  -- 检查并创建admin账号
  DECLARE
    account_count NUMBER;
  BEGIN
    SELECT COUNT(*) INTO account_count FROM ACCOUNT WHERE ACCOUNT = 'admin';
    
    IF account_count = 0 THEN
      INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
      VALUES ('admin', 'admin123', '管理员', '系统管理员', 1);
      DBMS_OUTPUT.PUT_LINE('管理员账号创建成功');
    ELSE
      DBMS_OUTPUT.PUT_LINE('管理员账号已存在');
    END IF;
  END;
END;
/

-- 检查并创建guest账号（用于权限测试）
BEGIN
  DECLARE
    account_count NUMBER;
  BEGIN
    SELECT COUNT(*) INTO account_count FROM ACCOUNT WHERE ACCOUNT = 'guest';
    
    IF account_count = 0 THEN
      INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
      VALUES ('guest', 'guest123', '游客', '普通用户', 5);
      DBMS_OUTPUT.PUT_LINE('普通用户账号创建成功');
    ELSE
      DBMS_OUTPUT.PUT_LINE('普通用户账号已存在');
    END IF;
  END;
END;
/

-- 清理现有数据
DELETE FROM RENT_STORE WHERE AREA_ID IN (5001, 5002, 5003, 5004, 5005, 5006, 5007, 5008);
DELETE FROM STORE_ACCOUNT WHERE STORE_ID IN (SELECT STORE_ID FROM STORE WHERE STORE_NAME LIKE '统计测试%');
DELETE FROM STORE WHERE STORE_NAME LIKE '统计测试%';
DELETE FROM RETAIL_AREA WHERE AREA_ID IN (5001, 5002, 5003, 5004, 5005, 5006, 5007, 5008);
DELETE FROM AREA WHERE AREA_ID IN (5001, 5002, 5003, 5004, 5005, 5006, 5007, 5008);

-- 1. 创建测试区域（8个区域，不同大小和租金）
-- 空置区域
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE, CATEGORY) VALUES (5001, 1, 50, 'RETAIL');   -- 小面积空置
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE, CATEGORY) VALUES (5002, 1, 80, 'EVENT');   -- 中面积空置

-- 已租用区域
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE,CATEGORY) VALUES (5003, 0, 120,'RETAIL');  -- 大面积已租
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE,CATEGORY) VALUES (5004, 0, 100,'RETAIL');  -- 中大面积已租
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE,CATEGORY) VALUES (5005, 0, 60,'RETAIL');   -- 小中面积已租
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE,CATEGORY) VALUES (5006, 0, 150,'RETAIL');  -- 特大面积已租
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE,CATEGORY) VALUES (5007, 0, 90,'RETAIL');   -- 中面积已租
INSERT INTO AREA (AREA_ID, ISEMPTY, AREA_SIZE,CATEGORY) VALUES (5008, 0, 75,'RETAIL');   -- 中小面积已租

-- 2. 创建对应的零售区域
INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5001, '空置', 8000.00);   -- 空置
INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5002, '空置', 12000.00);  -- 空置

INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5003, '已租用', 20000.00); -- 已租用
INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5004, '已租用', 16000.00); -- 已租用
INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5005, '已租用', 10000.00); -- 已租用
INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5006, '已租用', 25000.00); -- 已租用
INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5007, '已租用', 14000.00); -- 已租用
INSERT INTO RETAIL_AREA (AREA_ID, RENT_STATUS, BASE_RENT) VALUES (5008, '已租用', 11000.00); -- 已租用

-- 3. 创建不同类型和状态的测试店铺
-- 个人经营 - 正常营业
INSERT INTO STORE (STORE_ID, STORE_NAME, STORE_STATUS, STORE_TYPE, TENANT_NAME, CONTACT_INFO, RENT_START, RENT_END) 
VALUES (5003, '统计测试咖啡厅', '正常营业', '个人经营', '张三', '13800001003', DATE '2024-01-01', DATE '2025-12-31');

INSERT INTO STORE (STORE_ID, STORE_NAME, STORE_STATUS, STORE_TYPE, TENANT_NAME, CONTACT_INFO, RENT_START, RENT_END) 
VALUES (5005, '统计测试书店', '正常营业', '个人经营', '李四', '13800001005', DATE '2024-02-01', DATE '2025-01-31');

-- 企业连锁 - 正常营业
INSERT INTO STORE (STORE_ID, STORE_NAME, STORE_STATUS, STORE_TYPE, TENANT_NAME, CONTACT_INFO, RENT_START, RENT_END) 
VALUES (5004, '统计测试星巴克', '正常营业', '企业连锁', '星巴克中国', '13800001004', DATE '2024-01-15', DATE '2026-01-14');

INSERT INTO STORE (STORE_ID, STORE_NAME, STORE_STATUS, STORE_TYPE, TENANT_NAME, CONTACT_INFO, RENT_START, RENT_END) 
VALUES (5006, '统计测试优衣库', '正常营业', '企业连锁', '优衣库', '13800001006', DATE '2023-12-01', DATE '2025-11-30');

-- 个人经营 - 维修中
INSERT INTO STORE (STORE_ID, STORE_NAME, STORE_STATUS, STORE_TYPE, TENANT_NAME, CONTACT_INFO, RENT_START, RENT_END) 
VALUES (5007, '统计测试小餐厅', '维修中', '个人经营', '王五', '13800001007', DATE '2024-03-01', DATE '2025-02-28');

-- 企业连锁 - 暂停营业
INSERT INTO STORE (STORE_ID, STORE_NAME, STORE_STATUS, STORE_TYPE, TENANT_NAME, CONTACT_INFO, RENT_START, RENT_END) 
VALUES (5008, '统计测试便利店', '暂停营业', '企业连锁', '7-ELEVEn', '13800001008', DATE '2024-01-01', DATE '2024-12-31');

-- 4. 创建租赁关系
INSERT INTO RENT_STORE (STORE_ID, AREA_ID) VALUES (5003, 5003); -- 咖啡厅租用区域5003
INSERT INTO RENT_STORE (STORE_ID, AREA_ID) VALUES (5004, 5004); -- 星巴克租用区域5004
INSERT INTO RENT_STORE (STORE_ID, AREA_ID) VALUES (5005, 5005); -- 书店租用区域5005
INSERT INTO RENT_STORE (STORE_ID, AREA_ID) VALUES (5006, 5006); -- 优衣库租用区域5006
INSERT INTO RENT_STORE (STORE_ID, AREA_ID) VALUES (5007, 5007); -- 小餐厅租用区域5007
INSERT INTO RENT_STORE (STORE_ID, AREA_ID) VALUES (5008, 5008); -- 便利店租用区域5008

-- 5. 创建店铺账号
INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
VALUES ('cafe5003', 'pass123', '商户', '咖啡厅管理员', 4);

INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
VALUES ('starbucks5004', 'pass123', '商户', '星巴克管理员', 4);

INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
VALUES ('bookstore5005', 'pass123', '商户', '书店管理员', 4);

INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
VALUES ('uniqlo5006', 'pass123', '商户', '优衣库管理员', 4);

INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
VALUES ('restaurant5007', 'pass123', '商户', '小餐厅管理员', 4);

INSERT INTO ACCOUNT (ACCOUNT, PASSWORD, IDENTITY, USERNAME, AUTHORITY) 
VALUES ('seven5008', 'pass123', '商户', '便利店管理员', 4);

-- 建立店铺账号关联
INSERT INTO STORE_ACCOUNT (ACCOUNT, STORE_ID) VALUES ('cafe5003', 5003);
INSERT INTO STORE_ACCOUNT (ACCOUNT, STORE_ID) VALUES ('starbucks5004', 5004);
INSERT INTO STORE_ACCOUNT (ACCOUNT, STORE_ID) VALUES ('bookstore5005', 5005);
INSERT INTO STORE_ACCOUNT (ACCOUNT, STORE_ID) VALUES ('uniqlo5006', 5006);
INSERT INTO STORE_ACCOUNT (ACCOUNT, STORE_ID) VALUES ('restaurant5007', 5007);
INSERT INTO STORE_ACCOUNT (ACCOUNT, STORE_ID) VALUES ('seven5008', 5008);

-- 提交更改
COMMIT;

-- 6. 验证查询 - 统计报表相关数据验证
PROMPT '=== 商户信息统计报表测试数据验证 ===';

-- 基础统计
SELECT '总店铺数' AS 统计项, COUNT(*) AS 数值 FROM STORE WHERE STORE_NAME LIKE '统计测试%';
SELECT '正常营业店铺数' AS 统计项, COUNT(*) AS 数值 FROM STORE WHERE STORE_NAME LIKE '统计测试%' AND STORE_STATUS = '正常营业';
SELECT '总区域数' AS 统计项, COUNT(*) AS 数值 FROM AREA WHERE AREA_ID BETWEEN 5001 AND 5008;
SELECT '空置区域数' AS 统计项, COUNT(*) AS 数值 FROM AREA WHERE AREA_ID BETWEEN 5001 AND 5008 AND ISEMPTY = 1;

-- 按类型统计
SELECT '按类型统计' AS 标题, STORE_TYPE AS 店铺类型, COUNT(*) AS 店铺数量
FROM STORE 
WHERE STORE_NAME LIKE '统计测试%'
GROUP BY STORE_TYPE;

-- 按状态统计  
SELECT '按状态统计' AS 标题, STORE_STATUS AS 店铺状态, COUNT(*) AS 店铺数量
FROM STORE 
WHERE STORE_NAME LIKE '统计测试%'
GROUP BY STORE_STATUS;

-- 租金统计
SELECT '平均租金' AS 统计项, ROUND(AVG(BASE_RENT), 2) AS 数值
FROM RETAIL_AREA 
WHERE AREA_ID BETWEEN 5001 AND 5008 AND RENT_STATUS = '已租用';

SELECT '总租金收入' AS 统计项, SUM(BASE_RENT) AS 数值
FROM RETAIL_AREA 
WHERE AREA_ID BETWEEN 5001 AND 5008 AND RENT_STATUS = '已租用';

-- 入住率计算
SELECT '入住率统计' AS 标题,
       COUNT(*) AS 总区域数,
       SUM(CASE WHEN ISEMPTY = 0 THEN 1 ELSE 0 END) AS 已租用区域数,
       ROUND(SUM(CASE WHEN ISEMPTY = 0 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS 入住率百分比
FROM AREA 
WHERE AREA_ID BETWEEN 5001 AND 5008;

PROMPT '=== 测试数据创建完成 ===';
PROMPT '已创建6个商户（4个正常营业，1个维修中，1个暂停营业）';
PROMPT '包含个人经营和企业连锁两种类型';
PROMPT '8个区域中2个空置，6个已租用';
PROMPT '可用于测试各维度统计报表功能';
